<!DOCTYPE html>
<html lang="id" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Absensi Kantor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Inter', system-ui, sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    </style>
</head>
<body class="h-full bg-slate-50" x-data="attendanceApp()" x-init="init()">
    
    <!-- Loading Spinner -->
    <div x-show="isLoading" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-[100]">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-600"></div>
    </div>

    <!-- Login Page -->
    <div x-show="currentPage === 'login'" class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8">
            <div class="text-center">
                <div class="mx-auto h-16 w-16 bg-blue-600 rounded-2xl flex items-center justify-center">
                    <svg class="h-8 w-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <h2 class="mt-6 text-3xl font-bold text-slate-900">Absen Kantor Pusat Ibnu Kastir</h2>
                <p class="mt-2 text-sm text-slate-600">Bismillah | Alhamdulillah</p>
            </div>

            <div class="mt-8 space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <button @click="showLogin('employee')" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 min-h-[44px]">
                        Pegawai
                    </button>
                    <button @click="showLogin('admin')" class="w-full flex justify-center py-3 px-4 border border-slate-300 rounded-lg shadow-sm text-sm font-medium text-slate-700 bg-white hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 min-h-[44px]">
                        Admin
                    </button>
                </div>

                <div class="relative">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-slate-300"></div>
                    </div>
                    <div class="relative flex justify-center text-sm">
                        <span class="px-2 bg-slate-50 text-slate-500">Akses KPI dan Amal Yaumi</span>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                <a href="https://quran.com/" class="w-full flex justify-center py-3 px-4 border border-slate-300 rounded-lg shadow-sm text-sm font-medium text-slate-700 bg-white hover:bg-slate-50 min-h-[44px] items-center">
                    KPI 
                </a>
                <a href="https://quran.com/" target="_blank" class="w-full flex justify-center py-3 px-4 border border-slate-300 rounded-lg shadow-sm text-sm font-medium text-slate-700 bg-white hover:bg-slate-50 min-h-[44px] items-center">
                    Amal Yaumi
                </a>
            </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div x-show="showLoginModal" class="fixed inset-0 bg-slate-900 bg-opacity-50 overflow-y-auto h-full w-full z-50" x-cloak>
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-xl bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg font-medium text-slate-900" x-text="loginType === 'employee' ? 'Login Pegawai' : 'Login Admin'"></h3>
                <div class="mt-4 px-7 py-3">
                    <form @submit.prevent="login()" class="space-y-4">
                        <input x-model="loginForm.username" type="text" placeholder="Username" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <input x-model="loginForm.password" type="password" placeholder="Password" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <div class="flex space-x-2">
                            <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 font-medium">
                                Login
                            </button>
                            <button @click="closeLoginModal()" type="button" class="flex-1 bg-slate-300 text-slate-700 py-2 px-4 rounded-lg hover:bg-slate-400 font-medium">
                                Batal
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Employee Dashboard -->
    <div x-show="currentPage === 'employee'" class="min-h-screen" x-cloak>
        <!-- Mobile Header -->
        <header class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div>
                        <h1 class="text-xl font-semibold text-slate-900">Dashboard Pegawai</h1>
                        <p class="text-sm text-slate-600" x-text="'Halo, ' + currentUser.name"></p>
                    </div>
                    <button @click="logout()" class="text-slate-500 hover:text-slate-700">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            <!-- Today's Attendance -->
            <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                <h2 class="text-lg font-semibold text-slate-900 mb-4">Absensi Hari Ini</h2>
                <div class="text-center mb-4">
                    <div class="text-3xl font-bold text-slate-900" x-text="currentTime"></div>
                    <div class="text-sm text-slate-600" x-text="currentDate"></div>
                </div>
                
                <div x-show="!todayAttendance" class="space-y-3">
                    <div class="grid grid-cols-2 gap-3">
                        <button @click="markAttendance('present')" class="bg-emerald-600 text-white py-3 px-4 rounded-lg hover:bg-emerald-700 font-medium min-h-[44px] flex items-center justify-center">
                            Hadir Tepat Waktu
                        </button>
                        <button @click="showAttendanceForm('late')" class="bg-amber-600 text-white py-3 px-4 rounded-lg hover:bg-amber-700 font-medium min-h-[44px] flex items-center justify-center">
                            Terlambat
                        </button>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <button @click="showAttendanceForm('sick')" class="bg-red-600 text-white py-3 px-4 rounded-lg hover:bg-red-700 font-medium min-h-[44px] flex items-center justify-center">
                            Sakit
                        </button>
                        <button @click="showAttendanceForm('leave')" class="bg-slate-600 text-white py-3 px-4 rounded-lg hover:bg-slate-700 font-medium min-h-[44px] flex items-center justify-center">
                            Izin
                        </button>
                    </div>
                    <button @click="showAttendanceForm('wfe')" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 font-medium min-h-[44px] flex items-center justify-center">
                        Tugas diluar
                    </button>
                </div>

                <div x-show="todayAttendance" class="text-center p-4 bg-emerald-50 rounded-lg">
                    <div class="text-emerald-800 font-medium">Sudah absen</div>
                    <div class="text-sm text-emerald-600 mt-1" x-text="todayAttendance ? 'Status: ' + getStatusText(todayAttendance.status) + ' pada ' + todayAttendance.time : ''"></div>
                </div>
            </div>

            <!-- Monthly Summary -->
            <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                <h2 class="text-lg font-semibold text-slate-900 mb-4">Ringkasan Bulan Ini</h2>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                    <div class="text-center p-3 bg-emerald-50 rounded-lg">
                        <div class="text-2xl font-bold text-emerald-600" x-text="monthlyStats.present"></div>
                        <div class="text-sm text-emerald-700">Hadir</div>
                    </div>
                    <div class="text-center p-3 bg-amber-50 rounded-lg">
                        <div class="text-2xl font-bold text-amber-600" x-text="monthlyStats.late"></div>
                        <div class="text-sm text-amber-700">Terlambat</div>
                    </div>
                    <div class="text-center p-3 bg-red-50 rounded-lg">
                        <div class="text-2xl font-bold text-red-600" x-text="monthlyStats.sick"></div>
                        <div class="text-sm text-red-700">Sakit</div>
                    </div>
                    <div class="text-center p-3 bg-slate-50 rounded-lg">
                        <div class="text-2xl font-bold text-slate-600" x-text="monthlyStats.leave"></div>
                        <div class="text-sm text-slate-700">Izin</div>
                    </div>
                </div>
            </div>

            <!-- Recent History -->
            <div class="bg-white rounded-xl shadow-sm p-6">
                <h2 class="text-lg font-semibold text-slate-900 mb-4">Riwayat Absensi</h2>
                <div class="space-y-2 max-h-64 overflow-y-auto custom-scrollbar">
                    <template x-for="record in attendanceHistory" :key="record.date">
                        <div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
                            <div>
                                <div class="font-medium text-slate-900" x-text="formatDate(record.date)"></div>
                                <div class="text-sm text-slate-600" x-text="record.time"></div>
                            </div>
                            <div class="flex items-center">
                                <span class="px-2 py-1 rounded-full text-xs font-medium" :class="getStatusClass(record.status)" x-text="getStatusText(record.status)"></span>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </main>
    </div>

    <!-- Admin Dashboard -->
    <div x-show="currentPage === 'admin'" class="min-h-screen" x-cloak>
        <!-- Admin Header -->
        <header class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div>
                        <h1 class="text-xl font-semibold text-slate-900">Dashboard Admin</h1>
                        <p class="text-sm text-slate-600">Panel Manajemen Absensi</p>
                    </div>
                    <button @click="logout()" class="text-slate-500 hover:text-slate-700">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- Admin Tabs -->
                <div class="flex space-x-8 border-b border-slate-200">
                    <button @click="adminTab = 'overview'" :class="adminTab === 'overview' ? 'border-blue-600 text-blue-600' : 'border-transparent text-slate-500'" class="py-2 px-1 border-b-2 font-medium text-sm">
                        Overview
                    </button>
                    <button @click="adminTab = 'employees'" :class="adminTab === 'employees' ? 'border-blue-600 text-blue-600' : 'border-transparent text-slate-500'" class="py-2 px-1 border-b-2 font-medium text-sm">
                        Pegawai
                    </button>
                    <button @click="adminTab = 'attendance'" :class="adminTab === 'attendance' ? 'border-blue-600 text-blue-600' : 'border-transparent text-slate-500'" class="py-2 px-1 border-b-2 font-medium text-sm">
                        Absensi
                    </button>
                    <button @click="adminTab = 'reports'; initChart()" :class="adminTab === 'reports' ? 'border-blue-600 text-blue-600' : 'border-transparent text-slate-500'" class="py-2 px-1 border-b-2 font-medium text-sm">
                        Laporan
                    </button>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            <!-- Overview Tab -->
            <div x-show="adminTab === 'overview'">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-blue-100">
                                <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <div class="text-2xl font-bold text-slate-900" x-text="employees.length"></div>
                                <div class="text-sm text-slate-600">Total Pegawai</div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-emerald-100">
                                <svg class="h-6 w-6 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <div class="text-2xl font-bold text-slate-900" x-text="todayPresentCount"></div>
                                <div class="text-sm text-slate-600">Hadir Hari Ini</div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-amber-100">
                                <svg class="h-6 w-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <div class="text-2xl font-bold text-slate-900" x-text="employees.length - todayPresentCount"></div>
                                <div class="text-sm text-slate-600">Belum Absen</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Today's Attendance List -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h2 class="text-lg font-semibold text-slate-900 mb-4">Status Absensi Hari Ini</h2>
                    <div class="space-y-2 max-h-64 overflow-y-auto custom-scrollbar">
                        <template x-for="employee in employees" :key="employee.id">
                            <div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
                                <div>
                                    <div class="font-medium text-slate-900" x-text="employee.name"></div>
                                    <div class="text-sm text-slate-600" x-text="employee.position"></div>
                                </div>
                                <div class="flex items-center">
                                    <span class="px-2 py-1 rounded-full text-xs font-medium" :class="getTodayStatusClass(employee.id)" x-text="getTodayStatusText(employee.id)"></span>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Employees Tab -->
            <div x-show="adminTab === 'employees'">
                <div class="bg-white rounded-xl shadow-sm">
                    <div class="p-6 border-b border-slate-200">
                        <div class="flex justify-between items-center">
                            <h2 class="text-lg font-semibold text-slate-900">Manajemen Pegawai</h2>
                            <button @click="showEmployeeModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 font-medium">
                                + Tambah Pegawai
                            </button>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-slate-200">
                                <thead>
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Nama</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Jabatan</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-200">
                                    <template x-for="employee in employees" :key="employee.id">
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900" x-text="employee.name"></td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500" x-text="employee.position"></td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <span :class="employee.status === 'active' ? 'bg-emerald-100 text-emerald-800' : 'bg-red-100 text-red-800'" class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full">
                                                    <span x-text="employee.status === 'active' ? 'Aktif' : 'Nonaktif'"></span>
                                                </span>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                                <button @click="editEmployee(employee)" class="text-blue-600 hover:text-blue-900">Edit</button>
                                                <button @click="deleteEmployee(employee.id)" class="text-red-600 hover:text-red-900">Hapus</button>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Attendance Tab -->
            <div x-show="adminTab === 'attendance'">
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h2 class="text-lg font-semibold text-slate-900 mb-4">Monitoring Absensi</h2>
                    <div class="space-y-2 max-h-96 overflow-y-auto custom-scrollbar">
                        <template x-for="record in allAttendanceRecords" :key="record.id">
                            <div class="flex justify-between items-center p-4 bg-slate-50 rounded-lg">
                                <div class="flex-1">
                                    <div class="font-medium text-slate-900" x-text="getEmployeeName(record.employeeId)"></div>
                                    <div class="text-sm text-slate-600" x-text="formatDate(record.date) + ' - ' + record.time"></div>
                                    <div x-show="record.reason" class="text-sm text-slate-500" x-text="'Alasan: ' + record.reason"></div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="px-2 py-1 rounded-full text-xs font-medium" :class="getStatusClass(record.status)" x-text="getStatusText(record.status)"></span>
                                    <button @click="editAttendanceRecord(record)" class="text-blue-600 hover:text-blue-900 text-sm">Edit</button>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div x-show="adminTab === 'reports'">
                <div class="space-y-6">
                    <!-- Monthly Report Filter -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="text-lg font-semibold text-slate-900 mb-4">Filter Laporan Bulanan</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Bulan & Tahun</label>
                                <input 
                                    x-model="reportFilter.month" 
                                    @change="updateReports()"
                                    type="month" 
                                    class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div class="flex items-end">
                                <button 
                                    @click="exportMonthlyReport()" 
                                    class="w-full bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 font-medium">
                                    Export Excel
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Monthly Chart -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-semibold text-slate-900">
                                Laporan Absensi Bulanan - <span x-text="getSelectedMonthText()"></span>
                            </h2>
                        </div>
                        <div class="mb-4 grid grid-cols-2 md:grid-cols-5 gap-4">
                            <div class="text-center p-3 bg-emerald-50 rounded-lg">
                                <div class="text-xl font-bold text-emerald-600" x-text="monthlyReportStats.present"></div>
                                <div class="text-xs text-emerald-700">Hadir</div>
                            </div>
                            <div class="text-center p-3 bg-amber-50 rounded-lg">
                                <div class="text-xl font-bold text-amber-600" x-text="monthlyReportStats.late"></div>
                                <div class="text-xs text-amber-700">Terlambat</div>
                            </div>
                            <div class="text-center p-3 bg-red-50 rounded-lg">
                                <div class="text-xl font-bold text-red-600" x-text="monthlyReportStats.sick"></div>
                                <div class="text-xs text-red-700">Sakit</div>
                            </div>
                            <div class="text-center p-3 bg-slate-50 rounded-lg">
                                <div class="text-xl font-bold text-slate-600" x-text="monthlyReportStats.leave"></div>
                                <div class="text-xs text-slate-700">Izin</div>
                            </div>
                            <div class="text-center p-3 bg-blue-50 rounded-lg">
                                <div class="text-xl font-bold text-blue-600" x-text="monthlyReportStats.wfe"></div>
                                <div class="text-xs text-blue-700">wfe</div>
                            </div>
                        </div>
                        <div style="position: relative; height: 400px; width: 100%;">
                        <canvas id="attendanceChart"></canvas>
                        </div>
                    </div>

                    <!-- Monthly Attendance Rate per Employee -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="text-lg font-semibold text-slate-900 mb-4">
                            Tingkat Kehadiran per Pegawai - <span x-text="getSelectedMonthText()"></span>
                        </h3>
                        <div class="space-y-4">
                            <template x-for="employee in getFilteredEmployees()" :key="employee.id">
                                <div class="flex items-center justify-between p-4 bg-slate-50 rounded-lg">
                                    <div class="flex-1">
                                        <div class="font-medium text-slate-900" x-text="employee.name"></div>
                                        <div class="text-sm text-slate-600" x-text="employee.position"></div>
                                        <div class="text-xs text-slate-500 mt-1">
                                            <span x-text="getMonthlyEmployeeStats(employee.id).present + ' hadir'"></span>,
                                            <span x-text="getMonthlyEmployeeStats(employee.id).late + ' terlambat'"></span>,
                                            <span x-text="getMonthlyEmployeeStats(employee.id).sick + ' sakit'"></span>,
                                            <span x-text="getMonthlyEmployeeStats(employee.id).leave + ' izin'"></span>
                                        </div>
                                    </div>
                                    <div class="text-right ml-4">
                                        <div class="text-2xl font-bold text-slate-900" x-text="getMonthlyAttendanceRate(employee.id) + '%'"></div>
                                        <div class="text-sm text-slate-600">Tingkat Hadir</div>
                                        <div class="w-24 bg-slate-200 rounded-full h-2 mt-1">
                                            <div class="bg-blue-600 h-2 rounded-full" :style="'width: ' + getMonthlyAttendanceRate(employee.id) + '%'"></div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Attendance Form Modal -->
    <div x-show="showAttendanceModal" class="fixed inset-0 bg-slate-900 bg-opacity-50 overflow-y-auto h-full w-full z-50" x-cloak>
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-xl bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-slate-900 text-center" x-text="getAttendanceModalTitle()"></h3>
                <div class="mt-4 px-7 py-3">
                    <form @submit.prevent="submitAttendanceForm()" class="space-y-4">
                        <div x-show="attendanceForm.type === 'late' || attendanceForm.type === 'leave' || attendanceForm.type === 'wfe'">
                            <label class="block text-sm font-medium text-slate-700 mb-2">
                                <span x-text="attendanceForm.type === 'late' ? 'Alasan Terlambat' : (attendanceForm.type === 'leave' ? 'Alasan Izin' : 'Keterangan wfe')"></span>
                            </label>
                            <textarea x-model="attendanceForm.reason" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3" required></textarea>
                        </div>
                        <div x-show="attendanceForm.type === 'sick'">
                            <label class="block text-sm font-medium text-slate-700 mb-2">Keterangan Sakit</label>
                            <textarea x-model="attendanceForm.reason" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3" placeholder="Contoh: Demam, sakit kepala..."></textarea>
                        </div>
                        <div class="flex space-x-2">
                            <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 font-medium">
                                Submit Absensi
                            </button>
                            <button @click="closeAttendanceModal()" type="button" class="flex-1 bg-slate-300 text-slate-700 py-2 px-4 rounded-lg hover:bg-slate-400 font-medium">
                                Batal
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Employee Form Modal -->
    <div x-show="showEmployeeFormModal" class="fixed inset-0 bg-slate-900 bg-opacity-50 overflow-y-auto h-full w-full z-50" x-cloak>
        <div class="relative top-10 mx-auto p-5 border w-full max-w-md shadow-lg rounded-xl bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-slate-900 text-center" x-text="employeeForm.id ? 'Edit Pegawai' : 'Tambah Pegawai Baru'"></h3>
                <div class="mt-4 px-7 py-3">
                    <form @submit.prevent="submitEmployeeForm()" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Nama Lengkap</label>
                            <input x-model="employeeForm.name" type="text" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Jabatan</label>
                            <input x-model="employeeForm.position" type="text" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Username</label>
                            <input x-model="employeeForm.username" type="text" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div x-show="!employeeForm.id">
                            <label class="block text-sm font-medium text-slate-700 mb-2">Password</label>
                            <input x-model="employeeForm.password" type="password" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" :required="!employeeForm.id">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Status</label>
                            <select x-model="employeeForm.status" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                <option value="active">Aktif</option>
                                <option value="inactive">Nonaktif</option>
                            </select>
                        </div>
                        <div class="flex space-x-2">
                            <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 font-medium">
                                <span x-text="employeeForm.id ? 'Update' : 'Simpan'"></span>
                            </button>
                            <button @click="closeEmployeeModal()" type="button" class="flex-1 bg-slate-300 text-slate-700 py-2 px-4 rounded-lg hover:bg-slate-400 font-medium">
                                Batal
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Attendance Modal -->
    <div x-show="showEditAttendanceModal" class="fixed inset-0 bg-slate-900 bg-opacity-50 overflow-y-auto h-full w-full z-50" x-cloak>
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-xl bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-slate-900 text-center">Edit Absensi</h3>
                <div class="mt-4 px-7 py-3">
                    <form @submit.prevent="submitEditAttendance()" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Pegawai</label>
                            <input :value="getEmployeeName(editAttendanceForm.employeeId)" class="w-full px-3 py-2 border border-slate-300 rounded-lg bg-slate-100" readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Tanggal</label>
                            <input x-model="editAttendanceForm.date" type="date" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Status</label>
                            <select x-model="editAttendanceForm.status" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                <option value="present">Hadir</option>
                                <option value="late">Terlambat</option>
                                <option value="sick">Sakit</option>
                                <option value="leave">Izin</option>
                                <option value="wfe">wfe</option>
                                <option value="absent">Tidak Hadir</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Catatan Admin</label>
                            <textarea x-model="editAttendanceForm.adminNote" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" rows="2" placeholder="Catatan tambahan..."></textarea>
                        </div>
                        <div class="flex space-x-2">
                            <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 font-medium">
                                Update
                            </button>
                            <button @click="closeEditAttendanceModal()" type="button" class="flex-1 bg-slate-300 text-slate-700 py-2 px-4 rounded-lg hover:bg-slate-400 font-medium">
                                Batal
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variabel untuk menyimpan URL dan Kunci Supabase Anda
const supabaseUrl = 'https://vbvcydgjptjroclgcxzw.supabase.co';
const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZidmN5ZGdqcHRqcm9jbGdjeHp3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzMzYwODgsImV4cCI6MjA3MDkxMjA4OH0.7qhvpdcrMktJMISBzwU-PfVdSHqDnrOQKDM18-hMYN8';

// Ganti nama variabel untuk menghindari conflict
const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

        function attendanceApp() {
            return {
                // Current state
                currentPage: 'login',
                currentUser: null,
                currentTime: '',
                currentDate: '',
                adminTab: 'overview',
                
                // Modals
                showLoginModal: false,
                showAttendanceModal: false,
                showEmployeeFormModal: false,
                showEditAttendanceModal: false,
                loginType: 'employee',
                
                // Forms
                loginForm: { username: '', password: '' },
                attendanceForm: { type: '', reason: '' },
                employeeForm: { id: null, name: '', position: '', password: '', status: 'active' },
                editAttendanceForm: { id: null, employeeId: null, date: '', status: '', adminNote: '' },
                reportFilter: { 
                    month: new Date().toISOString().slice(0, 7), // Default to current month
                },
                
                // Data
                employees: [],
                attendanceRecords: [],
                todayAttendance: null,
                monthlyStats: { present: 0, late: 0, sick: 0, leave: 0 },
                monthlyReportStats: { present: 0, late: 0, sick: 0, leave: 0, wfe: 0 },
                attendanceHistory: [],
                allAttendanceRecords: [],
                
                // Chart instance
                chartInstance: null,
                
                init() {
                    this.updateDateTime();
                    setInterval(() => this.updateDateTime(), 1000);
                    this.loadInitialData();
                    this.updateReports();
                    this.updateAllAttendanceRecords();
                },
                
            async loadInitialData() {
            this.isLoading = true;
                try {
                    // Ganti 'supabase' menjadi 'supabaseClient'
                    const { data: employeesData, error: employeesError } = await supabaseClient
                        .from('employees')
                        .select('*');

                    if (employeesError) throw employeesError;
                    this.employees = employeesData;

                    const { data: attendanceData, error: attendanceError } = await supabaseClient
                        .from('attendance_records')
                        .select('*');

                    if (attendanceError) throw attendanceError;
                    this.attendanceRecords = attendanceData;

                    if (this.currentUser) {
                        this.updateAttendanceData();
                    }
                } catch (error) {
                    console.error('Error fetching data from Supabase:', error);
                    alert('Gagal memuat data dari database. Silakan coba lagi.');
                } finally {
                    this.isLoading = false;
                }
            },

                
                generateDemoAttendanceData() {
                    const now = new Date();
                    const demoRecords = [];
                    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                    const today = new Date();
                    
                    for (let d = new Date(startOfMonth); d <= today; d.setDate(d.getDate() + 1)) {
                        // Skip weekends
                        if (d.getDay() === 0 || d.getDay() === 6) continue;
                        
                        this.employees.forEach(employee => {
                            // Random attendance with higher probability of being present
                            const rand = Math.random();
                            let status = 'present';
                            
                            if (rand < 0.05) status = 'sick';
                            else if (rand < 0.1) status = 'leave';
                            else if (rand < 0.15) status = 'late';
                            else if (rand < 0.2) status = 'wfe';
                            
                            demoRecords.push({
                                id: Date.now() + Math.random(),
                                employeeId: employee.id,
                                date: d.toISOString().split('T')[0],
                                time: '08:' + String(Math.floor(Math.random() * 30)).padStart(2, '0'),
                                status: status,
                                reason: status !== 'present' ? 'Demo data' : ''
                            });
                        });
                    }
                    
                    this.attendanceRecords = demoRecords;
                    this.saveAttendanceRecords();
                },
                
                updateDateTime() {
                    const now = new Date();
                    const options = { timeZone: 'Asia/Jakarta' };
                    this.currentTime = now.toLocaleTimeString('id-ID', options);
                    this.currentDate = now.toLocaleDateString('id-ID', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric',
                        timeZone: 'Asia/Jakarta' 
                    });
                },
                
                showLogin(type) {
                    this.loginType = type;
                    this.showLoginModal = true;
                    this.loginForm = { username: '', password: '' };
                },
                
                closeLoginModal() {
                    this.showLoginModal = false;
                },
                
                // Perbaikan di dalam login()
                async login() {
                this.isLoading = true;
                const { username, password } = this.loginForm;

                try {
                    if (this.loginType === 'admin') {
                        if (username === 'admin' && password === 'admin123') {
                            this.currentUser = { id: 'admin', name: 'Administrator', role: 'admin' };
                            this.currentPage = 'admin';
                            this.closeLoginModal();
                            this.$nextTick(() => this.initChart());
                        } else {
                            alert('Username atau password admin salah!');
                        }
                    } else {
                        // Ganti 'supabase' menjadi 'supabaseClient'
                        const { data, error } = await supabaseClient
                            .from('employees')
                            .select('*')
                            .eq('username', username)
                            .eq('password', password)
                            .eq('status', 'active')
                            .single();

                        if (error) {
                            alert('Username atau password salah, atau akun tidak aktif!');
                        } else {
                            this.currentUser = { ...data, role: 'employee' };
                            this.currentPage = 'employee';
                            this.updateAttendanceData();
                            this.closeLoginModal();
                        }
                    }
                } catch (err) {
                    console.error('Login error:', err);
                    alert('Terjadi kesalahan saat login.');
                } finally {
                    this.isLoading = false;
                }
            },

                
                logout() {
                    this.currentUser = null;
                    this.currentPage = 'login';
                    this.todayAttendance = null;
                    if (this.chartInstance) {
                        this.chartInstance.destroy();
                        this.chartInstance = null;
                    }
                },
                
                updateAttendanceData() {
                    if (!this.currentUser || this.currentUser.role !== 'employee') return;
                    
                    const today = new Date().toDateString();
                    this.todayAttendance = this.attendanceRecords.find(record => 
                        record.employeeId === this.currentUser.id && 
                        new Date(record.date).toDateString() === today
                    );
                    
                    // Calculate monthly stats
                    const thisMonth = new Date();
                    const monthStart = new Date(thisMonth.getFullYear(), thisMonth.getMonth(), 1);
                    const monthEnd = new Date(thisMonth.getFullYear(), thisMonth.getMonth() + 1, 0);
                    
                    const monthlyRecords = this.attendanceRecords.filter(record => {
                        const recordDate = new Date(record.date);
                        return record.employeeId === this.currentUser.id &&
                               recordDate >= monthStart && recordDate <= monthEnd;
                    });
                    
                    this.monthlyStats = {
                        present: monthlyRecords.filter(r => r.status === 'present' || r.status === 'wfe').length, // UBAH: Tambahkan wfe ke perhitungan Hadir
                        late: monthlyRecords.filter(r => r.status === 'late').length,
                        sick: monthlyRecords.filter(r => r.status === 'sick').length,
                        leave: monthlyRecords.filter(r => r.status === 'leave').length // UBAH: Hapus wfe dari perhitungan Izin
                    };
                    
                    // Get recent history (last 30 days, excluding weekends)
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    
                    this.attendanceHistory = this.attendanceRecords
                        .filter(record => {
                            const recordDate = new Date(record.date);
                            const dayOfWeek = recordDate.getDay();
                            return record.employeeId === this.currentUser.id &&
                                   recordDate >= thirtyDaysAgo &&
                                   dayOfWeek !== 0 && dayOfWeek !== 6; // Exclude weekends
                        })
                        .sort((a, b) => new Date(b.date) - new Date(a.date))
                        .slice(0, 20);
                },
                
                updateReports() {
                    // Update monthly report stats based on filter
                    const [year, month] = this.reportFilter.month.split('-').map(Number);
                    const monthStart = new Date(year, month - 1, 1);
                    const monthEnd = new Date(year, month, 0);
                    
                    let filteredRecords = this.attendanceRecords.filter(record => {
                        const recordDate = new Date(record.date);
                        return recordDate >= monthStart && recordDate <= monthEnd;
                    });
                    
                    // Apply division filter
              //      if (this.reportFilter.division) {
           //             filteredRecords = filteredRecords.filter(record => {
            //                const employee = this.employees.find(emp => emp.id === record.employeeId);
             //               return employee && employee.division === this.reportFilter.division;
             //           });
              //      }
                    
                    this.monthlyReportStats = {
                        present: filteredRecords.filter(r => r.status === 'present').length,
                        late: filteredRecords.filter(r => r.status === 'late').length,
                        sick: filteredRecords.filter(r => r.status === 'sick').length,
                        leave: filteredRecords.filter(r => r.status === 'leave').length,
                        wfe: filteredRecords.filter(r => r.status === 'wfe').length
                    };
                    
                    // Update chart
                    this.updateChart();
                },
                
                updateChart() {
                    if (!this.chartInstance) return;
                    
                    this.chartInstance.data.datasets[0].data = [
                        this.monthlyReportStats.present,
                        this.monthlyReportStats.late,
                        this.monthlyReportStats.sick,
                        this.monthlyReportStats.leave,
                        this.monthlyReportStats.wfe
                    ];
                    this.chartInstance.update();
                },
                
                showAttendanceForm(type) {
                    this.attendanceForm = { type, reason: '' };
                    this.showAttendanceModal = true;
                },
                
                closeAttendanceModal() {
                    this.showAttendanceModal = false;
                },
                
                async markAttendance(status) {
                    this.isLoading = true;
                    const now = new Date();
                    const options = { timeZone: 'Asia/Jakarta' };
                    
                    const year = now.toLocaleString('en-US', { year: 'numeric', timeZone: 'Asia/Jakarta' });
                    const month = now.toLocaleString('en-US', { month: '2-digit', timeZone: 'Asia/Jakarta' });
                    const day = now.toLocaleString('en-US', { day: '2-digit', timeZone: 'Asia/Jakarta' });
                    const jakartaDate = `${year}-${month}-${day}`;

                    const attendance = {
                        employeeId: this.currentUser.id,
                        date: jakartaDate,
                        time: now.toLocaleTimeString('id-ID', options),
                        status: status,
                        reason: ''
                    };

                    try {
                        //  GANTI: supabase  supabaseClient
                        const { data, error } = await supabaseClient
                            .from('attendance_records')
                            .insert([attendance])
                            .select();

                        if (error) throw error;

                        this.attendanceRecords.push(data[0]);
                        this.updateAttendanceData();
                        alert('Absensi berhasil dicatat!');
                    } catch (err) {
                        console.error('Error submitting attendance:', err);
                        alert('Gagal mencatat absensi!');
                    } finally {
                        this.isLoading = false;
                    }
                },

async submitAttendanceForm() {
    this.isLoading = true;
    const now = new Date();
    const options = { timeZone: 'Asia/Jakarta' };
    const jakartaDate = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
    
    const newAttendance = {
        employeeId: this.currentUser.id,
        date: jakartaDate,
        time: now.toLocaleTimeString('id-ID', options),
        status: this.attendanceForm.type,
        reason: this.attendanceForm.reason
    };

    try {
        //  GANTI: supabase  supabaseClient
        const { data, error } = await supabaseClient
            .from('attendance_records')
            .insert([newAttendance])
            .select();

        if (error) throw error;

        this.attendanceRecords.push(data[0]);
        this.updateAttendanceData();
        this.closeAttendanceModal();
        alert('Absensi berhasil dicatat!');
    } catch (err) {
        console.error('Error submitting attendance:', err);
        alert('Gagal mencatat absensi!');
    } finally {
        this.isLoading = false;
    }
},
                
                getAttendanceModalTitle() {
                    const titles = {
                        late: 'Form Terlambat',
                        sick: 'Form Sakit',
                        leave: 'Form Izin',
                        wfe: 'Form Work From Home'
                    };
                    return titles[this.attendanceForm.type] || 'Form Absensi';
                },
                
                // Admin functions
                showEmployeeModal(employee = null) {
                    if (employee) {
                        this.employeeForm = { ...employee, password: '' };
                    } else {
                        this.employeeForm = { id: null, name: '', nip: '', position: '', password: '', status: 'active' };
                    }
                    this.showEmployeeFormModal = true;
                },
                
                closeEmployeeModal() {
                    this.showEmployeeFormModal = false;
                },
                
                async submitEmployeeForm() {
                    this.isLoading = true;
                    try {
                        if (this.employeeForm.id) {
                            // Update data pegawai
                            //  GANTI: supabase  supabaseClient
                            const { error } = await supabaseClient
                                .from('employees')
                                .update(this.employeeForm)
                                .eq('id', this.employeeForm.id);

                            if (error) throw error;
                        } else {
                            // Tambah pegawai baru
                            //  GANTI: supabase  supabaseClient
                            const { error } = await supabaseClient
                                .from('employees')
                                .insert({
                                    name: this.employeeForm.name,
                                    username: this.employeeForm.username,
                                    password: this.employeeForm.password,
                                    position: this.employeeForm.position,
                                    status: this.employeeForm.status
                                });

                            if (error) throw error;
                        }
                        await this.loadInitialData();
                        this.closeEmployeeModal();
                        alert(this.employeeForm.id ? 'Pegawai berhasil diupdate!' : 'Pegawai berhasil ditambahkan!');
                    } catch (err) {
                        console.error('Error submitting employee form:', err);
                        alert('Terjadi kesalahan saat menyimpan data pegawai.');
                    } finally {
                        this.isLoading = false;
                    }
                },
                
                editEmployee(employee) {
                    this.showEmployeeModal(employee);
                },
                
                async deleteEmployee(employeeId) {
                    if (confirm('Yakin ingin menghapus pegawai ini?')) {
                        this.isLoading = true;
                        try {
                            //  GANTI: supabase  supabaseClient
                            const { error } = await supabaseClient
                                .from('employees')
                                .delete()
                                .eq('id', employeeId);

                            if (error) throw error;

                            await this.loadInitialData();
                            alert('Pegawai berhasil dihapus!');
                        } catch (err) {
                            console.error('Error deleting employee:', err);
                            alert('Terjadi kesalahan saat menghapus pegawai.');
                        } finally {
                            this.isLoading = false;
                        }
                    }
                },
                
                editAttendanceRecord(record) {
                    this.editAttendanceForm = { ...record };
                    this.showEditAttendanceModal = true;
                },
                
                closeEditAttendanceModal() {
                    this.showEditAttendanceModal = false;
                },
                async submitEditAttendance() {
                    this.isLoading = true;
                    try {
                        //  GANTI: supabase  supabaseClient
                        const { error } = await supabaseClient
                            .from('attendance_records')
                            .update(this.editAttendanceForm)
                            .eq('id', this.editAttendanceForm.id);

                        if (error) throw error;

                        await this.loadInitialData();
                        this.closeEditAttendanceModal();
                        alert('Absensi berhasil diupdate!');
                    } catch (err) {
                        console.error('Error updating attendance record:', err);
                        alert('Terjadi kesalahan saat mengupdate absensi.');
                    } finally {
                        this.isLoading = false;
                    }
                },
                                
                exportMonthlyReport() {
                    // Export CSV for selected month and division
                    const [year, month] = this.reportFilter.month.split('-').map(Number);
                    const monthStart = new Date(year, month - 1, 1);
                    const monthEnd = new Date(year, month, 0);
                    
                    let filteredRecords = this.attendanceRecords.filter(record => {
                        const recordDate = new Date(record.date);
                        return recordDate >= monthStart && recordDate <= monthEnd;
                    });
                    
                    
                    const headers = ['Nama', 'Tanggal', 'Waktu', 'Status', 'Keterangan'];
                    const rows = filteredRecords.map(record => {
                        const employee = this.employees.find(emp => emp.id === record.employeeId);
                        return [
                            employee ? employee.name : 'Unknown',
                            this.formatDate(record.date),
                            record.time,
                            this.getStatusText(record.status),
                            record.reason || record.adminNote || ''
                        ];
                    });
                    
                    const csvContent = [headers, ...rows].map(row => row.join(',')).join('\n');
                    const blob = new Blob([csvContent], { type: 'text/csv' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const monthName = new Date(year, month - 1).toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });
                    a.download = `laporan_absensi_${monthName.replace(' ', '_')}.csv`;
                    a.click();
                    URL.revokeObjectURL(url);
                },
                
                getSelectedMonthText() {
                    if (!this.reportFilter.month) return 'Bulan Ini';
                    const [year, month] = this.reportFilter.month.split('-').map(Number);
                    return new Date(year, month - 1).toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });
                },
                
                getFilteredEmployees() {
                    return this.employees;
                },
                
                getMonthlyEmployeeStats(employeeId) {
                    const [year, month] = this.reportFilter.month.split('-').map(Number);
                    const monthStart = new Date(year, month - 1, 1);
                    const monthEnd = new Date(year, month, 0);
                    
                    const monthlyRecords = this.attendanceRecords.filter(record => {
                        const recordDate = new Date(record.date);
                        return record.employeeId === employeeId &&
                               recordDate >= monthStart && recordDate <= monthEnd;
                    });
                    
                    return {
                        present: monthlyRecords.filter(r => r.status === 'present').length,
                        late: monthlyRecords.filter(r => r.status === 'late').length,
                        sick: monthlyRecords.filter(r => r.status === 'sick').length,
                        leave: monthlyRecords.filter(r => r.status === 'leave').length,
                        wfe: monthlyRecords.filter(r => r.status === 'wfe').length
                    };
                },
                
                getMonthlyAttendanceRate(employeeId) {
                    const [year, month] = this.reportFilter.month.split('-').map(Number);
                    const monthStart = new Date(year, month - 1, 1);
                    const monthEnd = new Date(year, month, 0);
                    
                    // Count working days (exclude weekends)
                    let workingDays = 0;
                    for (let d = new Date(monthStart); d <= monthEnd; d.setDate(d.getDate() + 1)) {
                        if (d.getDay() !== 0 && d.getDay() !== 6) workingDays++;
                    }
                    
                    const presentRecords = this.attendanceRecords.filter(record => {
                        const recordDate = new Date(record.date);
                        return record.employeeId === employeeId &&
                               recordDate >= monthStart && recordDate <= monthEnd &&
                               ['present', 'late', 'wfe'].includes(record.status);
                    }).length;
                    
                    return workingDays > 0 ? Math.round((presentRecords / workingDays) * 100) : 0;
                },
                
                // Utility functions
                getStatusText(status) {
                    const statusTexts = {
                        present: 'Hadir',
                        late: 'Terlambat',
                        sick: 'Sakit',
                        leave: 'Izin',
                        wfe: 'wfe',
                        absent: 'Tidak Hadir'
                    };
                    return statusTexts[status] || status;
                },
                
                getStatusClass(status) {
                    const statusClasses = {
                        present: 'bg-emerald-100 text-emerald-800',
                        late: 'bg-amber-100 text-amber-800',
                        sick: 'bg-red-100 text-red-800',
                        leave: 'bg-slate-100 text-slate-800',
                        wfe: 'bg-blue-100 text-blue-800',
                        absent: 'bg-red-100 text-red-800'
                    };
                    return statusClasses[status] || 'bg-slate-100 text-slate-800';
                },
                
                formatDate(dateString) {
                    return new Date(dateString).toLocaleDateString('id-ID', {
                        weekday: 'short',
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                },
                
                getEmployeeName(employeeId) {
                    const employee = this.employees.find(emp => emp.id === employeeId);
                    return employee ? employee.name : 'Unknown';
                },
                
                getTodayStatusText(employeeId) {
                    const today = new Date().toDateString();
                    const record = this.attendanceRecords.find(record => 
                        record.employeeId === employeeId && 
                        new Date(record.date).toDateString() === today
                    );
                    return record ? this.getStatusText(record.status) : 'Belum Absen';
                },
                
                getTodayStatusClass(employeeId) {
                    const today = new Date().toDateString();
                    const record = this.attendanceRecords.find(record => 
                        record.employeeId === employeeId && 
                        new Date(record.date).toDateString() === today
                    );
                    return record ? this.getStatusClass(record.status) : 'bg-slate-100 text-slate-800';
                },
                
                getAttendanceRate(employeeId) {
                    const thisMonth = new Date();
                    const monthStart = new Date(thisMonth.getFullYear(), thisMonth.getMonth(), 1);
                    const monthEnd = new Date(thisMonth.getFullYear(), thisMonth.getMonth() + 1, 0);
                    
                    // Count working days (exclude weekends)
                    let workingDays = 0;
                    for (let d = new Date(monthStart); d <= monthEnd; d.setDate(d.getDate() + 1)) {
                        if (d.getDay() !== 0 && d.getDay() !== 6) workingDays++;
                    }
                    
                    const presentRecords = this.attendanceRecords.filter(record => {
                        const recordDate = new Date(record.date);
                        return record.employeeId === employeeId &&
                               recordDate >= monthStart && recordDate <= monthEnd &&
                               ['present', 'late', 'wfe'].includes(record.status);
                    }).length;
                    
                    return workingDays > 0 ? Math.round((presentRecords / workingDays) * 100) : 0;
                },
                
                get todayPresentCount() {
                    const today = new Date().toDateString();
                    return this.attendanceRecords.filter(record => 
                        new Date(record.date).toDateString() === today &&
                        ['present', 'late', 'wfe'].includes(record.status)
                    ).length;
                },
                
                get allAttendanceRecords() {
                    return this.attendanceRecords
                        .sort((a, b) => new Date(b.date) - new Date(a.date))
                        .slice(0, 50); // Show last 50 records
                },
                
                updateAllAttendanceRecords() {
                    // Trigger reactivity
                    this.attendanceRecords = [...this.attendanceRecords];
                },
              
                // menyimpan di localstorage  
          //      saveEmployees() {
           //         localStorage.setItem('employees', JSON.stringify(this.employees));
             //   },
                
             //   saveAttendanceRecords() {
             //       localStorage.setItem('attendanceRecords', JSON.stringify(this.attendanceRecords));
              //  },
                
                initChart() {
                    this.$nextTick(() => {
                        setTimeout(() => {
                            const ctx = document.getElementById('attendanceChart');
                            if (ctx && !this.chartInstance) {
                                this.chartInstance = new Chart(ctx, {
                                    type: 'bar',
                                    data: {
                                        labels: ['Hadir', 'Terlambat', 'Sakit', 'Izin', 'wfe'],
                                        datasets: [{
                                            label: 'Jumlah',
                                            data: [
                                                this.monthlyReportStats.present,
                                                this.monthlyReportStats.late,
                                                this.monthlyReportStats.sick,
                                                this.monthlyReportStats.leave,
                                                this.monthlyReportStats.wfe
                                            ],
                                            backgroundColor: [
                                                '#059669', // emerald-600
                                                '#d97706', // amber-600
                                                '#dc2626', // red-600
                                                '#64748b', // slate-500
                                                '#2563eb'  // blue-600
                                            ],
                                            borderWidth: 0,
                                            borderRadius: 8
                                        }]
                                    },
                                    options: {
                                        responsive: true,
                                        maintainAspectRatio: false,
                                        plugins: {
                                            legend: {
                                                display: false
                                            }
                                        },
                                        scales: {
                                            y: {
                                                beginAtZero: true,
                                                grid: {
                                                    color: '#f1f5f9'
                                                },
                                                ticks: {
                                                    color: '#64748b',
                                                    stepSize: 1
                                                }
                                            },
                                            x: {
                                                grid: {
                                                    display: false
                                                },
                                                ticks: {
                                                    color: '#64748b'
                                                }
                                            }
                                        },
                                        layout: {
                                            padding: {
                                                top: 20,
                                                bottom: 20
                                            }
                                        }
                                    }
                                });
                            }
                        }, 100);
                    });
                }
            }
        }
    </script>

    <style>
        [x-cloak] { display: none !important; }
        
        /* Custom scrollbar for better UX */
        .custom-scrollbar {
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 #f1f5f9;
        }
        
        /* Touch targets for mobile */
        @media (max-width: 768px) {
            button, .btn {
                min-height: 44px;
                min-width: 44px;
            }
        }
        
        /* Performance optimizations */
        * {
            box-sizing: border-box;
        }
        
        img {
            max-width: 100%;
            height: auto;
        }
        
        /* Smooth focus states */
        button:focus,
        input:focus,
        select:focus,
        textarea:focus {
            outline: 2px solid #2563eb;
            outline-offset: 2px;
        }
        
        /* Loading states */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        /* Mobile-first responsive design */
        .mobile-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        @media (min-width: 640px) {
            .mobile-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (min-width: 1024px) {
            .mobile-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        /* Accessibility improvements */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .bg-slate-50 { background-color: #ffffff; }
            .border-slate-200 { border-color: #000000; }
            .text-slate-600 { color: #000000; }
        }
        
        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        /* Print styles */
        @media print {
            .no-print {
                display: none !important;
            }
            
            body {
                background: white !important;
                color: black !important;
            }
            
            .bg-white {
                box-shadow: none !important;
            }
        }
        
        /* Dark mode preparation (can be activated later) */
        @media (prefers-color-scheme: dark) {
            .dark-mode {
                background-color: #1e293b;
                color: #f1f5f9;
            }
            
            .dark-mode .bg-white {
                background-color: #334155;
            }
            
            .dark-mode .text-slate-900 {
                color: #f1f5f9;
            }
        }
    </style>
</body>
</html>
